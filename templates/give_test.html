{% extends 'student_dashboard.html' %}
{% load static %}
{% block body %}
<div class="container-fluid w-100 px-4 pt-3 pb-3">
  <div class="d-flex justify-content-between align-items-center">
    <div class="d-block">
      <h2 class="h5 mb-0 text-dark font-weight-bold">Dashboard <span class="text-muted font-weight-normal">/ Give
          Exam</span></h2>
    </div>
    <div>
      <span class="badge badge-success bg-success px-3 py-2 rounded-pill text-white"
        style="font-size: 13px; font-weight: 600;"><i class="fas fa-check-circle mr-1"></i> SECURE SESSION</span>
    </div>
  </div>
</div>

<div class="row align-items-center d-flex justify-content-center w-100 mt-4">
  <div class="col-12 col-md-8 col-lg-6 mb-4">
    <div class="card border-light shadow-sm components-section align-items-center d-flex justify-content-center">
      <div class="card-body align-items-center d-flex justify-content-center">
        <div class="row mb-4">
          <div class="col-lg-12 col-sm-16">
            <h3 class="h3 text-center">EXAM LOGIN</h3>
          </div>
          <div class="card-body">
            <form action="{% url 'give_test' %}" method="POST" class="mt-4">
              {% csrf_token %}
              {% if form.errors %}
              <div class="alert alert-danger mb-3" role="alert">
                {% for field in form %}
                {% for error in field.errors %}
                <div>{{ error }}</div>
                {% endfor %}
                {% endfor %}
                {% for error in form.non_field_errors %}
                <div>{{ error }}</div>
                {% endfor %}
              </div>
              {% endif %}
              <div class="form-group">
                <label for="id_test_id">Test ID</label>
                <input type="text" name="test_id" class="form-control" id="id_test_id" placeholder="Enter Test ID"
                  value="{{ form.test_id.value|default:'' }}" required>
              </div>
              <div class="form-group">
                <label for="id_password">Password</label>
                <input type="password" name="password" class="form-control" id="id_password"
                  placeholder="Enter Test Password" required>
              </div>

              <div class="form-group text-center">
                <video id="stream" width="370" height="320" playsinline class="img-fluid rounded shadow-sm mb-2"
                  style="background: #000;"></video>
                <canvas id="capture" width="370" height="320" style="display:none;"></canvas>
                <br>
                <button id="btn-capture" type="button" class="btn btn-info">Capture Image</button>
                <br><br>
                <div id="snapshot" class="mb-3"></div>
                <input type="hidden" name="img_hidden_form" id="img_hidden"
                  value="{{ form.img_hidden_form.value|default:'' }}">
              </div>

              <input type="submit" class="btn btn-block btn-primary" value="Login For Exam" />
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  var btnCapture = document.getElementById("btn-capture");
  var stream = document.getElementById("stream");
  var capture = document.getElementById("capture");
  var snapshot = document.getElementById("snapshot");
  var cameraStream = null;

  btnCapture.addEventListener("click", captureSnapshot);

  function startStreaming() {
    var mediaSupport = 'mediaDevices' in navigator;
    if (mediaSupport && null == cameraStream) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (mediaStream) {
          cameraStream = mediaStream;
          stream.srcObject = mediaStream;
          stream.play();
          // Take a snapshot once stream starts after a small delay
          setTimeout(captureSnapshot, 1000);
        })
        .catch(function (err) {
          console.log("Unable to access camera: " + err);
        });
    } else {
      alert('Your browser does not support media devices.');
    }
  }

  function captureSnapshot() {
    if (null != cameraStream) {
      var ctx = capture.getContext('2d');
      var img = new Image();
      ctx.drawImage(stream, 0, 0, capture.width, capture.height);
      var dataURL = capture.toDataURL("image/png");
      img.src = dataURL;
      img.width = 370;
      img.height = 320;
      img.className = "img-fluid rounded shadow-sm";

      snapshot.innerHTML = '';
      snapshot.appendChild(img);

      var res = dataURL.replace("data:image/png;base64,", "");
      $("#img_hidden").val(res);
    }
  }

  window.onload = function () {
    startStreaming();
  }
</script>
{% endblock %}