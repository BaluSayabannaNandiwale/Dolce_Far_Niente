{% extends 'layout.html' %}
{% load static %}
{% block body %}
<main>
  <section class="section-header pb-6 pb-lg-7 bg-white">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
          <div class="card shadow-soft border-light p-4 p-lg-5">
            <div class="card-header bg-white border-0 text-center pb-0">
              <div class="mb-4">
                <i class="fas fa-shield-alt fa-3x text-primary mb-3"></i>
                <h1 class="h2 font-weight-bold mb-1">Secure Sign In</h1>
                <p class="text-muted">Access your personalized dashboard</p>
              </div>
            </div>

            <div class="card-body pt-2">
              <form action="{% url 'login' %}" method="POST" class="mt-2">
                {% csrf_token %}

                <!-- Email Field -->
                <div class="form-group mb-4">
                  <label for="email" class="h6 font-weight-bold">Email Address</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text bg-white border-right-0"><i
                          class="fas fa-envelope text-primary"></i></span>
                    </div>
                    <input name="email" id="email" class="form-control border-left-0 pl-0"
                      placeholder="example@company.com" type="email" required>
                  </div>
                </div>

                <!-- Password Field -->
                <div class="form-group mb-4">
                  <label for="password" class="h6 font-weight-bold">Password</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text bg-white border-right-0"><i
                          class="fas fa-key text-primary"></i></span>
                    </div>
                    <input name="password" id="password" type="password" class="form-control border-left-0 pl-0"
                      placeholder="Enter your password" required>
                  </div>
                </div>

                <!-- User Type Field -->
                <div class="form-group mb-4">
                  <label for="user_type" class="h6 font-weight-bold">Who are you?</label>
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text bg-white border-right-0"><i
                          class="fas fa-users text-primary"></i></span>
                    </div>
                    <select class="custom-select border-left-0 pl-0" id="user_type" name="user_type" required>
                      <option value="student" selected>Student</option>
                      <option value="teacher">Professor</option>
                    </select>
                  </div>
                </div>

                <!-- Face Verification Section -->
                <div class="verification-section mb-4 p-3 bg-light rounded shadow-inner">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0 font-weight-bold"><i class="fas fa-camera mr-2"></i>Face Verification</h6>
                    <span class="badge badge-primary px-2 py-1" style="font-size: 10px;">REQUIRED</span>
                  </div>

                  <div class="text-center position-relative">
                    <div class="video-container mx-auto"
                      style="width: 240px; height: 180px; overflow: hidden; border-radius: 12px; border: 3px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); background: #000;">
                      <video id="stream" width="240" height="180" autoplay muted playsinline
                        style="transform: scaleX(-1); object-fit: cover;"></video>
                      <canvas id="capture" width="240" height="180" style="display:none;"></canvas>
                    </div>

                    <div id="snapshot-container" class="mt-3" style="display:none;">
                      <p class="small text-success mb-1 font-weight-bold"><i class="fas fa-check-circle mr-1"></i> Image
                        Captured</p>
                      <div id="snapshot" class="mx-auto"
                        style="width: 120px; border-radius: 8px; overflow: hidden; border: 2px solid #28a745;"></div>
                    </div>

                    <button id="btn-capture" type="button" class="btn btn-sm btn-outline-primary mt-3">
                      <i class="fas fa-camera-retro mr-1"></i> Recapture Photo
                    </button>
                    <input type="hidden" id="image_hidden" name="image_hidden">
                  </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-4">
                  <a href="{% url 'lostpassword' %}" class="small font-weight-bold text-primary">Forgot password?</a>
                </div>

                <button type="submit" class="btn btn-block btn-primary shadow-soft py-3 font-weight-bold">
                  <i class="fas fa-sign-in-alt mr-2"></i> SIGN IN
                </button>
              </form>

              <div class="text-center mt-4">
                <span class="text-muted">Don't have an account? </span>
                <a href="{% url 'register' %}" class="font-weight-bold text-primary">Create Account</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<style>
  .shadow-inner {
    box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
  }

  .form-control:focus {
    box-shadow: none;
    border-color: #31316a;
  }

  .input-group-text {
    border-right: none;
  }

  .form-control {
    border-left: none;
  }
</style>

<script>
  var btnCapture = document.getElementById("btn-capture");
  var stream = document.getElementById("stream");
  var capture = document.getElementById("capture");
  var snapshot = document.getElementById("snapshot");
  var snapshotContainer = document.getElementById("snapshot-container");
  var cameraStream = null;

  btnCapture.addEventListener("click", captureSnapshot);

  function startStreaming() {
    var mediaSupport = 'mediaDevices' in navigator;
    if (mediaSupport && null == cameraStream) {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(function (mediaStream) {
          cameraStream = mediaStream;
          stream.srcObject = mediaStream;
          stream.play();

          // Auto capture after 2 seconds to give user time to center face
          setTimeout(captureSnapshot, 2000);
        })
        .catch(function (err) {
          console.log("Unable to access camera: " + err);
        });
    } else {
      alert('Your browser does not support media devices.');
    }
  }

  function stopStreaming() {
    if (null != cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      stream.load();
      cameraStream = null;
    }
  }

  function captureSnapshot() {
    if (null != cameraStream) {
      var ctx = capture.getContext('2d');
      ctx.drawImage(stream, 0, 0, capture.width, capture.height);

      var dataURL = capture.toDataURL("image/png");
      var img = new Image();
      img.src = dataURL;
      img.className = "img-fluid rounded";

      snapshot.innerHTML = '';
      snapshot.appendChild(img);
      snapshotContainer.style.display = 'block';

      var res = dataURL.replace("data:image/png;base64,", "");
      document.getElementById("image_hidden").value = res;
    }
  }

  window.onload = function () {
    startStreaming();
  }
</script>
{% endblock %}